@if (isLoading()) {
<app-loading-spinner />
} @else { @if (movieDetails(); as movie) {
<div class="container-fluid movie-details-container py-5"
  [style.background-image]="'url(https://image.tmdb.org/t/p/original' + movie.backdrop_path + ')'">
  <div class="container details-content">
    <div class="row">
      <div class="col-md-4 text-center">
        <img [src]="imageBaseUrl + movie.poster_path" class="img-fluid rounded shadow movie-poster-img"
          [alt]="movie.title" />
      </div>
      <div class="col-md-8">
        <h2>{{ movie.title }} 
          @if (movie.release_date) {
          ({{ movie.release_date | date : 'yyyy' }})
          }
        </h2>

        <!-- Quick Info Section -->
        @if (movie.release_date || (movie.genres && movie.genres.length > 0) || movie.runtime) {
        <div class="quick-info">
          @if (movie.release_date) {
          <span>{{ movie.release_date | date : 'MM/dd/yyyy' }}</span>
          <span class="dot-separator"></span>
          }
          
          @if (movie.genres && movie.genres.length > 0) {
          @for (genre of movie.genres; track genre.id) {
          <span>{{ genre.name }}@if (!$last) {, }</span>
          }
          <span class="dot-separator"></span>
          }
          
          @if (movie.runtime) {
          <span>{{ formatRuntime(movie.runtime) }}</span>
          }
        </div>
        }

        <!-- Tagline -->
        @if (movie.tagline) {
        <p class="tagline mt-3">
          <em>{{ movie.tagline }}</em>
        </p>
        }

        <div class="d-flex align-items-center gap-3 mb-3 action-bar">

          <div class="rating-badge clickable-rating" (click)="scrollToUserRatings()">
            <i class="bi bi-star-fill text-dark me-1"></i>
            <strong>{{ movie.vote_average.toFixed(1) }}</strong> / 10
          </div>

          <button class="btn btn-outline-warning btn-sm watchlist-trigger-btn" (click)="handleWatchlistClick()"
            [title]="isFavorite() ? 'Remove from Watchlist' : 'Add to Watchlist'" [class.active]="isFavorite()">
            <i [class]="isFavorite() ? 'bi bi-bookmark-heart-fill' : 'bi bi-bookmark-plus'"></i>
            {{ isFavorite() ? 'In Watchlist' : 'Add to Watchlist' }}
          </button>
        </div>

        <!-- Overview -->
        @if (movie.overview) {
        <div>
          <h4>Overview</h4>
          <p>{{ movie.overview }}</p>
        </div>
        }

        <!-- Featured Crew -->
        @if (featuredCrew().length > 0) {
        <div class="row crew-section md-4">
          @for (crewMember of featuredCrew(); track crewMember.credit_id) {
          <div class="col-md-4">
            <strong>{{ crewMember.name }}</strong>
            <p>{{ crewMember.job }}</p>
          </div>
          }
        </div>
        }
      </div>
    </div>
    <br />

    @if (movie.credits && movie.credits.cast && movie.credits.cast.length > 0) {
    <div class="row md-5">
      <div class="col-12">
        <h3 class="mb-4">Top Billed Cast</h3>
        <div class="cast-slider">
          @if (shouldShowCastButtons()) {
          <button class="slider-btn prev" (click)="scrollCast('prev')"><i class="bi bi-chevron-left"></i></button>
          }
          <div class="scrolling-wrapper" #scrollingWrapper>
            @for (actor of movie.credits.cast | slice:0:15; track actor.id) {
            <div class="actor-card">
              @if (actor.profile_path) {
              <img [src]="imageBaseUrl + actor.profile_path" [alt]="actor.name" class="actor-img">
              } @else {
              <div class="actor-img-placeholder"><i class="bi bi-person"></i></div>
              }
              <div class="actor-info">
                <strong>{{ actor.name }}</strong>
                <small>{{ actor.character }}</small>
              </div>
            </div>
            }
          </div>
          @if (shouldShowCastButtons()) {
          <button class="slider-btn next" (click)="scrollCast('next')"><i class="bi bi-chevron-right"></i></button>
          }
        </div>
      </div>
    </div>
    }
  </div>
</div>

<div class="container my-5">

  @if (mediaItems().length > 0) {
  <div>
    <h3 class="mb-4">Media</h3>
    <div class="media-slider">
      @if (shouldShowMediaButtons()) {
      <button class="slider-btn prev" (click)="scrollMedia('prev')"><i class="bi bi-chevron-left"></i></button>
      }
      <div class="scrolling-wrapper media-scroller" #mediaScroller>
        @for (item of mediaItems(); track (item.media_type === 'video' ? item.key : item.file_path); let i = $index) {
        <div class="media-card" (click)="openImageGallery(i)">
          @switch (item.media_type) {
          @case ('video') {
          <div class="video-container">
            <iframe [src]="item.safeUrl" title="YouTube video player" frameborder="0" allowfullscreen></iframe>
          </div>
          }
          @case ('backdrop') {
          <img [src]="getFullImagePath(item.file_path)" alt="Backdrop">
          }
          @case ('poster') {
          <img [src]="getFullImagePath(item.file_path)" alt="Poster">
          }
          }
        </div>
        }
      </div>
      @if (shouldShowMediaButtons()) {
      <button class="slider-btn next" (click)="scrollMedia('next')"><i class="bi bi-chevron-right"></i></button>
      }
    </div>
    <hr class="my-5" />
  </div>
  }

  <div class="user-ratings-section" id="userRatings">
    <h3 class="mb-4">User Ratings & Reviews</h3>

    <div class="ratings-summary">
      <div class="rating-score">
        <div class="score-circle">
          <span class="score">{{ (getLocalVoteAverage() || 0).toFixed(1) }}</span>
          <span class="out-of">/10</span>
        </div>
        <div class="rating-stars">
          <div class="interactive-stars">
            @for (star of [1,2,3,4,5,6,7,8,9,10]; track star) {
            <i class="bi bi-star-fill star" [class.active]="star <= (tempRating() || userRating() || 0)"
              [class.rated]="star <= userRating()" (click)="handleUserRating(star)" (mouseenter)="onStarHover(star)"
              (mouseleave)="onStarLeave()">
            </i>
            }
          </div>

          <div class="user-rating-info">
            @if (userRating() > 0) {
            <p class="your-rating">
              Your rating: <strong>{{ userRating() }}/10</strong>
            </p>
            <p class="click-to-remove">Click your rating to remove it</p>
            } @else {
            <p class="rate-prompt">Rate this movie</p>
            }
          </div>

          <span class="vote-count">{{ (getLocalVoteCount() || 0).toLocaleString() }} votes</span>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="reviews-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <button class="btn btn-warning btn-sm" (click)="openReviewForm()" [disabled]="!authService.isLoggedIn()">
            <i class="bi bi-pencil-square me-2"></i>Write a Review
          </button>
        </div>

        <!-- Review Form -->
        @if (showReviewForm()) {
        <div class="review-form-container mb-4">
          <div class="review-form-card">
            <div class="review-form-header">
              <h5>{{ isEditingReview() ? 'Edit Your Review' : 'Write Your Review' }}</h5>
              <button class="btn-close" (click)="closeReviewForm()"></button>
            </div>
            <div class="review-form-body">
              <div class="mb-3">
                <label for="reviewContent" class="form-label fw-bold text-dark">Your Review</label>
                <textarea 
                  id="reviewContent"
                  class="form-control review-textarea" 
                  rows="4" 
                  placeholder="Share your thoughts about this movie..."
                  [(ngModel)]="newReview().content"
                  [disabled]="isSubmittingReview() || userRating() === 0">
                </textarea>
                @if (userRating() === 0) {
                <div class="form-text text-warning">
                  <i class="bi bi-lock me-1"></i>
                  Review box is locked until you rate the movie
                </div>
                }
              </div>
              
              <div class="review-form-actions">
                <button class="btn btn-secondary" (click)="closeReviewForm()" [disabled]="isSubmittingReview()">
                  Cancel
                </button>
                <button class="btn btn-warning" (click)="submitReview()" [disabled]="isSubmittingReview() || userRating() === 0">
                  @if (isSubmittingReview()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  {{ isEditingReview() ? 'Updating...' : 'Submitting...' }}
                  } @else {
                  {{ isEditingReview() ? 'Update Review' : 'Submit Review' }}
                  }
                </button>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Reviews List -->
        @if (reviews().length > 0) {
        <div class="reviews-list">
          @for (review of reviews(); track review.id) {
          <div class="review-card">
            <div class="review-header">
              <div class="reviewer-info">
                <div class="reviewer-avatar placeholder-avatar">
                  <i class="bi bi-person-fill"></i>
                </div>
                <div class="reviewer-details">
                  <h6 class="reviewer-name">{{ review.author_details.name }}</h6>
                  <span class="review-date">{{ formatReviewDate(review.created_at) }}</span>
                </div>
              </div>
              @if (review.author_details.rating) {
              <div class="review-rating">
                <div class="stars">
                  @for (star of [1,2,3,4,5,6,7,8,9,10]; track star) {
                  <i class="bi bi-star-fill" [class.filled]="star <= getStarRating(review.author_details.rating)"></i>
                  }
                </div>
                <span class="rating-value">{{ review.author_details.rating }}/10</span>
              </div>
              }
            </div>
            <div class="review-content">
              <p>{{ review.content }}</p>
            </div>
            
            <!-- Review Actions -->
            <div class="review-actions">
              <!-- Like Button -->
              <button class="like-btn" (click)="toggleLikeReview(review.id)" 
                      [class.liked]="isReviewLikedByUser(review.id)">
                <i class="bi bi-heart{{ isReviewLikedByUser(review.id) ? '-fill' : '' }}"></i>
                <span class="likes-count">{{ review.likes_count || 0 }}</span>
              </button>
              
              <!-- Edit/Delete Buttons (for user's own reviews only) -->
              @if (review.author === authService.getCurrentUserEmail()) {
              <div class="user-review-actions">
                <button class="edit-review-btn" (click)="openReviewForm()">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="delete-review-btn" (click)="deleteReview(review.id)">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
              }
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="no-reviews text-center py-4">
          <i class="bi bi-chat-square-text display-6 text-muted mb-3"></i>
          <h5 class="text-muted">No reviews yet</h5>
          <p class="text-muted">Be the first to share your thoughts about this movie!</p>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Recommendations Section -->
  @if (recommendations().length > 0) {
  <div class="container all">
    <h2 class="mb-4 text-white fa-lg">
      Recommendations<i class="fa-solid fa-chevron-right fa-xs"></i>
    </h2>
    <div class="movies-slider-wrapper">
      <div class="movies-slider" #slider>
        @for (movie of recommendations(); track movie.id) {
        <div class="col">
          <app-movie-card [movie]="movie" />
        </div>
        }
      </div>
      @if (shouldShowRecommendationsButtons()) {
      <button class="slider-btn prev" (click)="scrollRecommendations('prev')">&lt;</button>
      <button class="slider-btn next" (click)="scrollRecommendations('next')">&gt;</button>
      }
    </div>
  </div>
  }
</div>
} }

<!-- Gallery Modal -->
@if (showGallery()) {
<div class="gallery-overlay" (click)="closeGallery()">
  <div class="gallery-content" (click)="$event.stopPropagation()">
    <button class="gallery-close" (click)="closeGallery()">
      <i class="bi bi-x-lg"></i>
    </button>
    
    <div class="gallery-image-container">
      <img [src]="getFullImagePath(getCurrentGalleryImage())" 
           [alt]="'Gallery image ' + (currentGalleryIndex() + 1)"
           class="gallery-image">
      
      <!-- Navigation Buttons -->
      @if (canNavigatePrevious()) {
      <button class="gallery-nav-btn prev" (click)="navigateGallery('prev')">
        <i class="bi bi-chevron-left"></i>
      </button>
      }
      
      @if (canNavigateNext()) {
      <button class="gallery-nav-btn next" (click)="navigateGallery('next')">
        <i class="bi bi-chevron-right"></i>
      </button>
      }
    </div>
    
    <!-- Gallery Info -->
    <div class="gallery-info">
      <span class="gallery-counter">
        {{ currentGalleryIndex() + 1 }} / {{ getGalleryImages().length }}
      </span>
    </div>
  </div>
</div>
}

<app-back-to-top />

<!-- Snackbar for Login -->
@if(showLoginSnackbar()){
<div class="snackbar-overlay" (click)="dismissSnackbar()">
  <div class="snackbar-content" (click)="$event.stopPropagation()">
    <button class="snackbar-close" (click)="dismissSnackbar()">&times;</button>
    <div class="snackbar-icon">
      <i class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <div class="snackbar-text">
      <h4>Login Required</h4>
      <p>{{ loginSnackbarMessage() }}</p>
    </div>
    <div class="snackbar-actions">
      <a (click)="navigateTo('/auth/register')" class="register-link">Don't have an account?
        <strong>Register</strong></a>
      <button class="btn btn-warning login-btn" (click)="navigateTo('/auth/login')">Login</button>
    </div>
  </div>
</div>
}